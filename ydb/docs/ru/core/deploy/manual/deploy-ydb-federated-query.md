# Развертывание YDB с функцией Federated Query

{% note warning %}

Данная функциональность находится в режиме "Preview".

{% endnote %}

## Общая схема инсталляции

{{ ydb-full-name }} может выполнять [федеративные запросы](../../concepts/federated_query/index.md) ко внешним источникам (например, объектным хранилищам или реляционным СУБД) без необходимости перемещения их данных непосредственно в {{ ydb-short-name }}. В данном разделе мы рассмотрим изменения, которые необходимо внести в конфигурацию {{ ydb-short-name }} и окружающую инфраструктуру для включения функциональности федеративных запросов. 

{% note info %}

Для организации доступа к некоторым из источников данных требуется развертывание специального микросервиса - [коннектора](../../concepts/federated_query/architecture.md#connectors). Ознакомьтесь c [перечнем поддерживаемых источников](../../concepts/federated_query/architecture.md#suppored-datasources), чтобы понять, требуется ли вам установка коннектора.

{% endnote %}
 
{{ ydb-short-name }} и внешние источники данных в варианте production-инсталляции должны разворачиваться, очевидно, на разных физических или виртуальных серверах, в том числе в облаках. Коннектор, в случае, если его использование необходимо для доступа к требуемому источнику данных, может быть развернут согласно следующим схемам:

* На одном и том же физическом или виртуальном сервере c {{ ydb-short-name }}, причём {{ ydb-short-name }} разворачивается с помощью [бинарных файлов](./deploy-ydb-on-premises.md#install-binaries), а коннектор - с помощью Docker-образа.
* На отдельном от {{ ydb-short-name }} физическом или виртуальном сервере. 

При этом должны выполняться следующие требования:
* источник данных должен быть доступен по сети для запросов со стороны YDB или со стороны коннектора (при его наличии);
* коннектор должен быть доступен по сети для запросов со стороны {{ ydb-short-name }}.

![Инсталляция {{ ydb-short-name }} FQ](_images/ydb_fq_onprem.png "Инсталляция {{ ydb-short-name }} FQ" =640x)

{% note info %}

В настоящее время мы не поддерживаем развёртывание коннектора в {{k8s}}, но планируем добавить её в ближайшем будущем.

Если вам необходимо развернуть несколько инстансов коннектора в целях отказоустойчивости, используйте доступные вам средства балансировки, например, DNS-балансировку. Конфигурационный файл YDB на данный момент поддерживает указание только одного адреса коннектора.

{% endnote %}

## Пошаговое руководство

1. Если для доступа к нужному вам источнику требуется развернуть коннектор, сделайте это [согласно инструкции](./connector.md).
1. Выполните шаги инструкции по развертыванию {{ ydb-short-name }} до [подготовки конфигурационных файлов](./deploy-ydb-on-premises.md#config) включительно.
1. В конфигурационном файле {{ ydb-short-name }} в секции `query_service_config` добавьте подсекцию `generic` по приведённому ниже образцу. В полях `connector.endpoint.host` и `connector.endpoint.port` укажите сетевой адрес коннектора, а в поле `connector.use_ssl` укажите, использует ли коннектор шифрованные соединения:
    ```yaml
    query_service_config:
        generic:
            connector:
                endpoint:
                    host: connector_host  # имя хоста, где развернут коннектор
                    port: 50051           # номер порта, на котором развернут слушающий сокет коннектора
                use_ssl: true             # флаг, включающий шифрование соединений
            default_settings:
                - name: DateTimeFormat
                  value: string
                - name: UsePredicatePushdown
                  value: "true"
    ```
1. В конфигурационном файле {{ ydb-short-name }} добавьте секцию `feature_flags` следующего содержания:
    ```yaml
    feature_flags:
        enable_external_data_sources: true
        enable_script_execution_operations: true
    ```
1. Продолжайте развертывание {{ ydb-short-name }} по [инструкции](./deploy-ydb-on-premises.md). 
